# syntax=docker/dockerfile:1.7
# Development image keeps tooling required for hot-reload workflows
FROM python:3.11-slim

ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    TMP_UPLOAD_DIR=/app/tmp_uploads

WORKDIR /app

# Install build tools (needed for certain python deps) and clean layer afterwards
RUN apt-get update && \
    apt-get install --no-install-recommends -y build-essential && \
    rm -rf /var/lib/apt/lists/*

# Copy only requirements so dependency installs benefit from Docker cache
COPY requirements.txt ./
RUN python -m pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install "uvicorn[standard]"

# Create upload directory with secure permissions
RUN mkdir -p ${TMP_UPLOAD_DIR} && chmod 700 ${TMP_UPLOAD_DIR}

# Default command assumes the backend source is volume-mounted at runtime
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
